/**
 * Deploy LobsterConversions contract to Monad mainnet.
 * 
 * Usage:
 *   PRIVATE_KEY=0x... node scripts/deploy-conversions.js
 * 
 * Or with wallet file:
 *   WALLET_FILE=/path/to/wallet.json node scripts/deploy-conversions.js
 */

import { createWalletClient, createPublicClient, http, defineChain } from 'viem';
import { privateKeyToAccount } from 'viem/accounts';
import fs from 'fs';

const monad = defineChain({
  id: 10143,
  name: 'Monad',
  nativeCurrency: { name: 'MON', symbol: 'MON', decimals: 18 },
  rpcUrls: { default: { http: ['https://mainnet.monad.xyz'] } },
});

// Compiled bytecode and ABI — generated by solc 0.8.20+
// To recompile: solc --bin --abi contracts/LobsterConversions.sol -o build/
// For now, we use the pre-compiled artifacts from build/
async function main() {
  // Load private key
  let privateKey = process.env.PRIVATE_KEY;
  if (!privateKey) {
    const walletFile = process.env.WALLET_FILE || '/home/jidra/.openclaw/workspace/.secrets/wallet-mainnet.json';
    if (fs.existsSync(walletFile)) {
      const wallet = JSON.parse(fs.readFileSync(walletFile, 'utf-8'));
      privateKey = wallet.privateKey || wallet.private_key;
    }
  }
  if (!privateKey) {
    console.error('No private key. Set PRIVATE_KEY env or WALLET_FILE path.');
    process.exit(1);
  }

  // Load compiled artifacts
  const buildDir = new URL('../build/', import.meta.url).pathname;
  if (!fs.existsSync(buildDir + 'LobsterConversions.abi') || !fs.existsSync(buildDir + 'LobsterConversions.bin')) {
    console.error('Missing build artifacts. Compile first:');
    console.error('  solc --bin --abi --optimize contracts/LobsterConversions.sol -o build/ --overwrite');
    process.exit(1);
  }

  const abi = JSON.parse(fs.readFileSync(buildDir + 'LobsterConversions.abi', 'utf-8'));
  const bytecode = '0x' + fs.readFileSync(buildDir + 'LobsterConversions.bin', 'utf-8').trim();

  const account = privateKeyToAccount(privateKey.startsWith('0x') ? privateKey : `0x${privateKey}`);
  console.log(`Deploying from: ${account.address}`);

  const publicClient = createPublicClient({ chain: monad, transport: http() });
  const walletClient = createWalletClient({ account, chain: monad, transport: http() });

  // Check balance
  const balance = await publicClient.getBalance({ address: account.address });
  console.log(`Balance: ${Number(balance) / 1e18} MON`);
  if (balance === 0n) {
    console.error('No MON balance for gas!');
    process.exit(1);
  }

  // Deploy
  console.log('Deploying LobsterConversions...');
  const hash = await walletClient.deployContract({ abi, bytecode, gas: 1_000_000n });
  console.log(`TX hash: ${hash}`);
  
  const receipt = await publicClient.waitForTransactionReceipt({ hash });
  console.log(`✅ Deployed at: ${receipt.contractAddress}`);
  console.log(`Block: ${receipt.blockNumber}`);

  // Save deployment info
  const deployInfo = {
    address: receipt.contractAddress,
    deployer: account.address,
    txHash: hash,
    blockNumber: Number(receipt.blockNumber),
    chain: 'monad-mainnet',
    chainId: 10143,
    timestamp: new Date().toISOString(),
  };
  fs.writeFileSync(buildDir + 'deployment.json', JSON.stringify(deployInfo, null, 2));
  console.log('Saved deployment info to build/deployment.json');

  // Print env var to add
  console.log(`\nAdd to .env:`);
  console.log(`CONVERSIONS_CONTRACT=${receipt.contractAddress}`);
}

main().catch(e => { console.error(e); process.exit(1); });
